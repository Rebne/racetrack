<!DOCTYPE html>
<html>

<head>
    <script src="/socket.io/socket.io.js"></script>
    <script>
        class Driver {
            constructor(name, car) {
                this.name = name;
                this.car = car;
            }
        }
        class Race {
            constructor(id) {
                this.id = id;
                this.drivers = [];
                this.availableCars =
                    [8, 7, 6, 5, 4, 3, 2, 1];
            }

            get getDrivers() {
                return this.drivers;
            }

            addDriver(name, car = null) {
                if (car < 1 || car > 8) {
                    return {error: true, code: 'overflow'}
                }
                if (this.availableCars.length === 0) {
                    return { error: true, code: 'capacity' }
                }
                const matchingDriver = this.drivers.filter((driver) => driver.name === name);
                if (matchingDriver.length > 0) {
                    return { error: true, code: 'name' };
                }
                const matchingCar = this.drivers.filter((driver) => driver.car === car);
                if (matchingCar.length > 0) {
                    return { error: true, code: 'car' };
                }
                if (car === null) {
                    car = this.availableCars.pop();
                }
                const newDriver = new Driver(name, car);
                this.drivers.push(newDriver);

                return { error: false, code: null };
            }

            removeDriver(name) {
                const currentLength = this.drivers.length;
                this.drivers = this.drivers.filter((driver) => {
                    if (driver.name === name) {
                        this.availableCars.push(driver.car);
                        return true; 
                    }
                    return false;
                });
                return this.drivers.length !== currentLength;
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            let races = [];
            let idCounter = 1;

            const socket = io();

            socket.on('start:race', () => {
                const activeRace = races.shift();
            });

            function createRace() {
                const race = new Race(idCounter);
                races.push(race);
                idCounter++;

                const raceDiv = document.createElement('div');
                raceDiv.className = 'race';
                raceDiv.id = `race-${race.id}`;

                const raceTitle = document.createElement('h2');
                raceTitle.textContent = `Race ${race.id}`;
                raceDiv.appendChild(raceTitle);

                const addDriverForm = document.createElement('form');
                addDriverForm.innerHTML = `
                    <input type="text" placeholder="Driver Name" id="driver-name-${race.id}">
                    <input type="text" placeholder="Car" id="car-num-${race.id}">
                    <button type="submit">Add Driver</button>
                `;
                addDriverForm.onsubmit = (e) => {
                    e.preventDefault();
                    const driverName = document.getElementById(`driver-name-${race.id}`).value;
                    const carNum = document.getElementById(`car-num-${race.id}`).value;
                    const result = race.addDriver(driverName, carNum);
                    if (!result.error) {
                        updateRaceDisplay(race);
                    } else {
                        switch (result.code) {
                            case 'overflow':
                                alert('Invalid number entered\nAvailable car numbers are in range 1 - 8');
                                break
                            case 'capacity':
                                alert('Maximum number of drivers (8) exceeded');
                                break;
                            case 'name':
                                alert('Driver name already taken');
                                break;
                            default:
                                alert('Car number already taken');
                        }

                    }
                };
                raceDiv.appendChild(addDriverForm);
                const closeButton = document.createElement('button');
                closeButton.className = 'close-button';
                closeButton.id = `close-button-${race.id}`;
                closeButton.textContent = 'X';
                closeButton.addEventListener('click', () => {
                    removeRace(race.id);
                });
                raceDiv.appendChild(closeButton);

                document.body.appendChild(raceDiv);
                updateAddRaceDiv();

            }
            
            function removeRace(raceID) {
                const raceToRemove = document.getElementById(`race-${raceID}`);
                raceToRemove.remove();
            }

            function updateAddRaceDiv() {
                let addRaceDiv = document.getElementById('add-race');
                if (!addRaceDiv) {
                    addRaceDiv = document.createElement('div');
                    addRaceDiv.className = 'race';
                    addRaceDiv.id = 'add-race';
                    addRaceDiv.textContent = '+';
                    addRaceDiv.onclick = createRace;
                }
                document.body.appendChild(addRaceDiv);
            }

            function updateRaceDisplay(race) {
                const raceDiv = document.getElementById(`race-${race.id}`);
                const existingDriver = raceDiv.querySelectorAll('.driver');
                existingDriver.forEach((driver) => driver.remove());

                race.getDrivers.forEach((driver) => {
                    const driverDiv = document.createElement('div');
                    driverDiv.className = 'driver';
                    driverDiv.textContent = `${driver.name} - Car ${driver.car}`;
                    raceDiv.appendChild(driverDiv);
                });
                updateAddRaceDiv();
            }

            updateAddRaceDiv();
        });
    </script>
    <style>
        body {
            display: flex;
            margin: 0;
            padding: 0;
            width: 100vw;
            min-height: 100vh;
            flex-wrap: wrap;
            box-sizing: border-box;
        }

        .race {
            position: relative;
            display: flex;
            flex-direction: column;
            box-sizing: border-box;
            width: 25vw;
            height: 50vh;
            border: 1px solid #ccc;
            margin: 0;
            padding: 10px;
        }
        
        .close-button {
            position: absolute;
            top: 5px;
            right: 5px;
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
        }

        .driver {
            width: 100%;
            margin: 5px 0;
            padding: 5px;
            background-color: #f0f0f0;
        }

        #add-race {
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 48px;
            cursor: pointer;
            background-color: #f0f0f0;
        }

        #add-race:hover {
            background-color: #e0e0e0;
        }
    </style>
</head>

<body>

</body>

</html>