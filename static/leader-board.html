<!DOCTYPE html>

<html>
<head>
    <meta charset="UTF-8">
    <title>Leaderboard</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="../flag.js"></script>
    <script src="../countdown.js"></script>
    <script src="../fetchdata.js"></script>
    <script src="../models.js"></script>
    <script>
    
    //GLOBAL variables
    let raceStartTime;
    const bestLapTimes = new Map();
    const carNameMap = new Map();
    let currentLapCount;
    let lastLapTimestamp;
    let countdownTime = 10 * 60;
    //this is an object because int/number cannot be passed to a function as a reference
    let timeRemaining = {seconds: countdownTime};

    function min(a, b) {
        if (a < b) {return a;}
        else {return b;}
    }

    function carsSortedByLapTime(map) {
        return Array.from(map.entries())
        .sort((a, b) => a[1] - b[1])
        .map(entry => entry[0]);
    }

    function removeDrivers() {
        const drivers = document.querySelectorAll('.driver');
        drivers.forEach((driver) => driver.remove());
    }

    function removeAll() {
        removeDrivers();
        const flag = document.getElementById('flag');
        flag.remove();
        const countdown = document.getElementById('countdown');
        countdown.classList.add('hidden');
    }

    function lapTimeAsString(ms) {
        if (ms === Infinity) {return '00:00.0';}
        let result = '';
        const roundedSeconds = Math.round(ms / 1000);
        const minutes = Math.floor(roundedSeconds / 60);
        const seconds = roundedSeconds % 60;
        const millis = Math.floor((ms % 1000) / 100);
        
        //min
        if (minutes >= 10) {
            result += minutes.toString();
        } else {
            result += '0' + minutes.toString();
        }
        result += ':';
        //sec
        if (seconds >= 10) {
            result += seconds.toString();
        } else {
            result += '0' + seconds.toString();
        }
        //ms
        result += '.' + millis.toString();
        return result;
    }

    function reloadDrivers(){
        removeDrivers();
        const carsInOrder = carsSortedByLapTime(bestLapTimes);
        const container = document.getElementById('container');

        carsInOrder.forEach(car => {
            const name = carNameMap.get(car);
            const driverDiv = document.createElement('div');
            driverDiv.id = car;
            driverDiv.className = 'driver';
            const lapTime = bestLapTimes.get(car);
            const numLap = currentLapCount[car].toString();
            driverDiv.textContent = `Best lap: ${lapTimeAsString(lapTime)} Name: ${name} Car: ${car} Current lap: ${numLap}`;

            container.appendChild(driverDiv);
        });
    }

    function initializeDrivers(drivers, startTime) {
        // Initialize last lap to start time for comparison
        // +1 is added to length to be able to index with car numbers without changing them
        lastLapTimestamp = new Array(drivers.length + 1).fill(startTime);
        currentLapCount = new Array(drivers.length + 1).fill(1); 

        const container = document.getElementById('container');
        drivers.forEach(driver => {
            const driverDiv = document.createElement('div');
            driverDiv.id = driver.car;
            driverDiv.className = 'driver';
            driverDiv.textContent = `Best lap: 00:00.0 Name: ${driver.name} Car: ${driver.car} Current lap: 1`;
            bestLapTimes.set(driver.car, Infinity);
            carNameMap.set(driver.car, driver.name);
            container.appendChild(driverDiv);
        });
    }

    function renderFlag() {
        const flag = document.createElement('div');
        flag.id = 'flag';
        document.getElementById('container').appendChild(flag);
    }

    function updateLapTime(car) {
        const now = Date.now();
        const prev = lastLapTimestamp[car];
        lastLapTimestamp[car] = now;
        const current = now - prev;
        const prevBest = bestLapTimes.get(car);
        bestLapTimes.set(car, min(current, prevBest));
    }

    document.addEventListener("DOMContentLoaded", () => {
        const socket = io();

        socket.on('devMode', (data) => {
            if (data.isDevMode) {
                countdownTime = 1 * 60;
                timeRemaining.seconds = countdownTime;
            };
            //swapping to 1:00 for idle value
            const timer = document.getElementById('countdown');
            timer.textContent = '1:00';
        });
        
        socket.on('race:data', (raceData) => {
            raceStartTime = Date.now();
            initializeDrivers(raceData.drivers, raceStartTime);
        });

        socket.on('start:race', () => {
            const countdown = document.getElementById('countdown');
            countdown.classList.remove('hidden');
            updateCountdown(timeRemaining);
            renderFlag();
        });

        socket.on('flag:swap', (message) => {
            const flag = document.getElementById('flag');
            const color = flag_colors.get(message);
            if (message == 'finished') {
                createCheckeredFlag(flag);
            } else {
                removeCheckeredFlag();
                flag.style.backgroundColor = flag_colors.get(message);
            }
        });

        socket.on('lap-recorded', (car) => {
            updateLapTime(car)
            currentLapCount[car]++;
            reloadDrivers();
        });

        socket.on('finish:race', ()=> {
            //resetting timer
            timeRemaining.seconds = countdownTime;
            removeAll();
        });

        socket.on('connect', () => {
            console.log('Connected to server');
        });

    });

    </script>
</head>

<style>
    body {
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        margin: 0;
    }

    #container {
        width: 100%;
    }

    #flag {
        width: 200px; 
        height: 150px; 
        display: flex;
        flex-wrap: wrap;
        background-color: green;
    }

    .hidden {
        display: none;
    }
</style>

<body>
    <div id="container">
        <div class="hidden" id="countdown">10:00</div>
    </div>
</body>
</html>
