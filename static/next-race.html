<!DOCTYPE html>
<html>
<head>
    <title>Next Race</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="../fetchdata.js"></script>
    <script>
        const socket = io();

        function min(x, y) {
            if (x < y) {
                return x
            } else {
                return y
            }
        }

        async function getNextRace() {

            races = await getRacesInDB();
            if (!races || races.length == 0) {return -1};

            nextRace = races[0].id;
            for (const row of races) {
                nextRace = min(nextRace, row.id);
            }

            return nextRace

        }

        function generateDrivers(raceID, drivers) {
            const nextRaceDiv = document.getElementById('next-race');
            nextRaceDiv.innerHTML = `
                <h2>Next Race: ${raceID}</h2>
                <ul>
                    ${drivers.map(driver => `<li>${driver.name} - Car ${driver.car}</li>`).join('')}
                </ul>
            `;
        }

        function removePreviousRace() {
            const nextRace = document.getElementById('next-race');
            nextRace.innerHTML = '';
        }

        async function initializeRaceData() {

           const nextRace = await getNextRace();
            let drivers;
            if (nextRace !== -1) {
                drivers = await getDriversInDB(nextRace);
            }

            const nextRaceDiv = document.getElementById('next-race');
            if (Array.isArray(drivers) && drivers.length > 0) {
                generateDrivers(nextRace, drivers);
            } else {
                const message = document.createElement('h2');
                message.textContent = 'No races in queue'
                nextRaceDiv.appendChild(message);
            }
        }

        socket.on('connect', () => {
            console.log('Connected to server');
        });

        socket.on('start:race', ()=> {
            removePreviousRace();
            initializeRaceData();
        });

        document.addEventListener('DOMContentLoaded', () => {
            initializeRaceData();
        });
    </script>
</head>
<body>
    <div id="next-race"></div>
</body>
</html>
